<div class="orders-management">
  <div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h2 class="page-title">
          <i class="fas fa-clipboard-list"></i>
          Orders Management
        </h2>
        <p class="page-subtitle">Track and manage all orders</p>
      </div>
      <div class="header-actions">
        <button class="btn btn-primary" (click)="loadOrders()" [disabled]="isLoading">
          <i class="fas fa-sync" [class.fa-spin]="isLoading"></i>
          Refresh
        </button>
      </div>
    </div>
  </div>

  <!-- Success/Error Messages -->
  <div *ngIf="successMessage" class="alert alert-success alert-dismissible">
    <i class="fas fa-check-circle"></i>
    {{ successMessage }}
    <button type="button" class="btn-close" (click)="clearMessages()"></button>
  </div>

  <div *ngIf="errorMessage" class="alert alert-danger alert-dismissible">
    <i class="fas fa-exclamation-triangle"></i>
    {{ errorMessage }}
    <button type="button" class="btn-close" (click)="clearMessages()"></button>
  </div>

  <!-- Filters Section -->
  <div class="filters-section">
    <div class="card">
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-2">
            <label class="form-label">Order Status</label>
            <select class="form-select" [(ngModel)]="filters.status" (ngModelChange)="onFilterChange()">
              <option *ngFor="let option of statusOptions" [value]="option.value">
                {{ option.label }}
              </option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">Payment Status</label>
            <select class="form-select" [(ngModel)]="filters.paymentStatus" (ngModelChange)="onFilterChange()">
              <option *ngFor="let option of paymentStatusOptions" [value]="option.value">
                {{ option.label }}
              </option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">Date From</label>
            <input type="date" class="form-control" [(ngModel)]="filters.dateFrom" (ngModelChange)="onFilterChange()">
          </div>
          <div class="col-md-2">
            <label class="form-label">Date To</label>
            <input type="date" class="form-control" [(ngModel)]="filters.dateTo" (ngModelChange)="onFilterChange()">
          </div>
          <div class="col-md-3">
            <label class="form-label">Search</label>
            <div class="input-group">
              <span class="input-group-text">
                <i class="fas fa-search"></i>
              </span>
              <input type="text" class="form-control" placeholder="Search orders..." [(ngModel)]="filters.search"
                (ngModelChange)="onSearchChange()">
            </div>
          </div>
          <div class="col-md-1">
            <label class="form-label">Per Page</label>
            <select class="form-select" [(ngModel)]="filters.limit" (ngModelChange)="onFilterChange()">
              <option value="10">10</option>
              <option value="25">25</option>
              <option value="50">50</option>
            </select>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-state">
    <div class="text-center">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-3">Loading orders...</p>
    </div>
  </div>

  <!-- Orders Table -->
  <div *ngIf="!isLoading" class="orders-table">
    <div class="card">
      <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Orders ({{ totalOrders }})</h5>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead>
            <tr>
              <th>Order ID</th>
              <th>Customer</th>
              <th>Restaurant</th>
              <th>Status</th>
              <th>Payment</th>
              <th>Amount</th>
              <th>Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let order of filteredOrders">
              <td>
                <div class="order-id">
                  <strong>#{{ order.id.substring(0, 8) }}</strong>
                </div>
              </td>
              <td>
                <div class="customer-info">
                  <div class="customer-name">{{ order.customer.firstName }} {{ order.customer.lastName }}</div>
                  <small class="text-muted">{{ order.customer.email }}</small>
                </div>
              </td>
              <td>
                <div class="restaurant-info">
                  <div class="restaurant-name">{{ order.restaurant.name }}</div>
                  <small class="text-muted">{{ order.restaurant.email }}</small>
                </div>
              </td>
              <td>
                <span [class]="getStatusBadgeClass(order.status)">
                  {{ order.status | titlecase }}
                </span>
              </td>
              <td>
                <span [class]="getPaymentStatusBadgeClass(order.paymentStatus)">
                  {{ order.paymentStatus | titlecase }}
                </span>
                <br>
                <small class="text-muted">{{ order.paymentMethod | titlecase }}</small>
              </td>
              <td>
                <div class="amount-info">
                  <strong>{{ formatCurrency(order.totalAmount) }}</strong>
                  <small class="text-muted d-block">+{{ formatCurrency(order.deliveryFee) }} delivery</small>
                </div>
              </td>
              <td>
                <div class="date-info">
                  {{ formatDate(order.createdAt) }}
                </div>
              </td>
              <td>
                <div class="action-buttons">
                  <button class="btn btn-outline-primary btn-sm" (click)="viewOrder(order)" title="View Details">
                    <i class="fas fa-eye"></i>
                  </button>
                  <button class="btn btn-outline-warning btn-sm" (click)="updateStatus(order)" title="Update Status"
                    *ngIf="canUpdateStatus(order)">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn btn-outline-danger btn-sm" (click)="cancelOrder(order)" title="Cancel Order"
                    *ngIf="canCancelOrder(order)">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>

        <!-- Empty State -->
        <div *ngIf="filteredOrders.length === 0" class="empty-state">
          <div class="text-center py-5">
            <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">No orders found</h5>
            <p class="text-muted">Try adjusting your filters or search criteria.</p>
          </div>
        </div>
      </div>

      <!-- Pagination -->
      <div class="card-footer" *ngIf="totalPages > 1">
        <nav>
          <ul class="pagination justify-content-center mb-0">
            <li class="page-item" [class.disabled]="currentPage === 1">
              <button class="page-link" (click)="onPageChange(currentPage - 1)">
                <i class="fas fa-chevron-left"></i>
              </button>
            </li>

            <li class="page-item" *ngFor="let page of generatePageNumbers()" [class.active]="page === currentPage">
              <button class="page-link" (click)="onPageChange(page)">{{ page }}</button>
            </li>

            <li class="page-item" [class.disabled]="currentPage === totalPages">
              <button class="page-link" (click)="onPageChange(currentPage + 1)">
                <i class="fas fa-chevron-right"></i>
              </button>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  </div>
</div>

<!-- Order Details Modal -->
<div class="modal fade show" [style.display]="showOrderModal ? 'block' : 'none'" *ngIf="showOrderModal" tabindex="-1">
  <div class="modal-backdrop fade show" (click)="closeModal()"></div>
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-clipboard-list"></i>
          Order Details - #{{ currentOrder?.id!.substring(0, 8) }}
        </h5>
        <button type="button" class="btn-close" (click)="closeModal()"></button>
      </div>
      <div class="modal-body" *ngIf="currentOrder">
        <div class="row">
          <div class="col-md-6">
            <h6>Customer Information</h6>
            <table class="table table-sm">
              <tr>
                <td><strong>Name:</strong></td>
                <td>{{ currentOrder.customer.firstName }} {{ currentOrder.customer.lastName }}</td>
              </tr>
              <tr>
                <td><strong>Email:</strong></td>
                <td>{{ currentOrder.customer.email }}</td>
              </tr>
              <tr>
                <td><strong>Delivery Address:</strong></td>
                <td>
                  {{ currentOrder.deliveryAddress.street }}<br>
                  {{ currentOrder.deliveryAddress.city }}, {{ currentOrder.deliveryAddress.state }}
                </td>
              </tr>
            </table>
          </div>
          <div class="col-md-6">
            <h6>Order Information</h6>
            <table class="table table-sm">
              <tr>
                <td><strong>Restaurant:</strong></td>
                <td>{{ currentOrder.restaurant.name }}</td>
              </tr>
              <tr>
                <td><strong>Status:</strong></td>
                <td>
                  <span [class]="getStatusBadgeClass(currentOrder.status)">
                    {{ currentOrder.status | titlecase }}
                  </span>
                </td>
              </tr>
              <tr>
                <td><strong>Payment:</strong></td>
                <td>
                  <span [class]="getPaymentStatusBadgeClass(currentOrder.paymentStatus)">
                    {{ currentOrder.paymentStatus | titlecase }}
                  </span>
                  ({{ currentOrder.paymentMethod | titlecase }})
                </td>
              </tr>
              <tr>
                <td><strong>Total Amount:</strong></td>
                <td><strong>{{ formatCurrency(currentOrder.totalAmount) }}</strong></td>
              </tr>
            </table>
          </div>
        </div>

        <div class="row mt-3">
          <div class="col-12">
            <h6>Order Items</h6>
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Item</th>
                  <th>Quantity</th>
                  <th>Price</th>
                  <th>Total</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of currentOrder.items">
                  <td>{{ item.mealName }}</td>
                  <td>{{ item.quantity }}</td>
                  <td>{{ formatCurrency(item.price) }}</td>
                  <td>{{ formatCurrency(item.price * item.quantity) }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeModal()">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Status Update Modal -->
<div class="modal fade show" [style.display]="showStatusModal ? 'block' : 'none'" *ngIf="showStatusModal" tabindex="-1">
  <div class="modal-backdrop fade show" (click)="closeModal()"></div>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-edit"></i>
          Update Order Status
        </h5>
        <button type="button" class="btn-close" (click)="closeModal()"></button>
      </div>
      <form [formGroup]="statusForm" (ngSubmit)="submitStatusUpdate()">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">New Status</label>
            <select class="form-select" formControlName="status">
              <option value="pending">Pending</option>
              <option value="confirmed">Confirmed</option>
              <option value="preparing">Preparing</option>
              <option value="ready">Ready</option>
              <option value="picked_up">Picked Up</option>
              <option value="delivered">Delivered</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" [disabled]="!statusForm.valid">
            Update Status
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Cancel Order Modal -->
<div class="modal fade show" [style.display]="showCancelModal ? 'block' : 'none'" *ngIf="showCancelModal" tabindex="-1">
  <div class="modal-backdrop fade show" (click)="closeModal()"></div>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-times text-danger"></i>
          Cancel Order
        </h5>
        <button type="button" class="btn-close" (click)="closeModal()"></button>
      </div>
      <form [formGroup]="cancelForm" (ngSubmit)="submitCancellation()">
        <div class="modal-body">
          <p>Are you sure you want to cancel this order?</p>
          <div class="mb-3">
            <label class="form-label">Cancellation Reason</label>
            <textarea class="form-control" rows="3" formControlName="reason"
              placeholder="Enter reason for cancellation..." required></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeModal()">Cancel</button>
          <button type="submit" class="btn btn-danger" [disabled]="!cancelForm.valid">
            <i class="fas fa-times"></i>
            Cancel Order
          </button>
        </div>
      </form>
    </div>
  </div>
</div>