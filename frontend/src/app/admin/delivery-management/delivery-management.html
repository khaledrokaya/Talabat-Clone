<div class="delivery-management">
  <!-- Enhanced Page Header -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-info">
        <h1 class="text-light">
          <i class="fas fa-motorcycle"></i>
          Delivery Partner Review
        </h1>
        <p>Review pending applications and manage existing delivery partners</p>
        <div class="quick-stats">
          <div class="stat-item">
            <span class="stat-value">{{ getDeliveryStats().total }}</span>
            <span class="stat-label">Total Partners</span>
          </div>
          <div class="stat-item">
            <span class="stat-value">{{ getDeliveryStats().pending }}</span>
            <span class="stat-label">Pending Approval</span>
          </div>
          <div class="stat-item">
            <span class="stat-value">{{ getDeliveryStats().verified }}</span>
            <span class="stat-label">Verified Partners</span>
          </div>
        </div>
      </div>
      <div class="header-actions">
        <button class="btn btn-outline-light" (click)="refreshData()" [disabled]="isLoading">
          <i class="fas fa-sync" [class.fa-spin]="isLoading"></i>
          Refresh Data
        </button>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-state">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <h3>Loading delivery partners...</h3>
      <p>Please wait while we fetch the delivery data</p>
    </div>
  </div>

  <!-- Delivery Partners Grid -->
  <div class="delivery-grid" *ngIf="!isLoading && filteredDelivery.length > 0">
    <div class="grid-container">
      <div class="delivery-card" *ngFor="let delivery of getPaginatedDelivery(); let i = index">
        <!-- Delivery Partner Header -->
        <div class="delivery-header">
          <div class="delivery-avatar">
            <img [src]="delivery.documents?.identityProof || 'assets/default-avatar.png'" alt="Delivery Partner"
              (error)="handleImageError($event)" class="avatar-image">
          </div>
          <div class="delivery-info">
            <h5 class="delivery-name">{{ delivery.firstName }} {{ delivery.lastName }}</h5>
            <p class="delivery-id">ID: {{ delivery._id.substring(0, 8) }}</p>
            <div class="status-badges">
              <span class="status-badge" [ngClass]="getStatusBadgeClass(delivery.verificationStatus)">
                <i
                  [class]="'fas fa-' + (delivery.verificationStatus === 'pending' ? 'clock' : delivery.verificationStatus === 'verified' ? 'check' : 'times')"></i>
                {{ delivery.verificationStatus | titlecase }}
              </span>
              <span class="status-badge" [ngClass]="delivery.isOnline ? 'online' : 'offline'">
                <i class="fas fa-circle"></i>
                {{ delivery.isOnline ? 'Online' : 'Offline' }}
              </span>
            </div>
          </div>
        </div>

        <!-- Quick Info Section -->
        <div class="quick-info-grid">
          <div class="info-item">
            <i class="fas fa-envelope"></i>
            <span>{{ delivery.email }}</span>
          </div>
          <div class="info-item">
            <i class="fas fa-phone"></i>
            <span>{{ delivery.phone }}</span>
          </div>
          <div class="info-item">
            <i class="fas fa-map-marker-alt"></i>
            <span>{{ delivery.address?.city }}, {{ delivery.address?.state }}</span>
          </div>
          <div class="info-item">
            <i class="fas fa-calendar-day"></i>
            <span>Applied: {{ formatDate(delivery.createdAt) }}</span>
          </div>
        </div>

        <!-- Document Verification Section -->
        <div class="verification-section">
          <h6 class="section-title">
            <i class="fas fa-file-alt"></i> Document Verification
          </h6>
          <div class="document-grid">
            <div class="document-item" (click)="openDocument(delivery.documents?.licenseImage)">
              <i class="fas fa-id-card"></i>
              <span>Driver License</span>
              <span class="document-status">{{ delivery.documents?.licenseNumber || 'Not provided' }}</span>
            </div>
            <div class="document-item" (click)="openDocument(delivery.documents?.vehicleRegistration)">
              <i class="fas fa-car"></i>
              <span>Vehicle Registration</span>
            </div>
            <div class="document-item" (click)="openDocument(delivery.documents?.identityProof)">
              <i class="fas fa-user-tie"></i>
              <span>ID Proof</span>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="delivery-actions">
          <button class="btn btn-sm btn-view" (click)="viewDeliveryDetails(delivery)" title="View Full Details">
            <i class="fas fa-eye"></i>
            View Details
          </button>

          <div class="action-group" *ngIf="delivery.verificationStatus === 'pending'">
            <button class="btn btn-sm btn-approve" (click)="approveDelivery(delivery, 'verified')"
              title="Approve Partner">
              <i class="fas fa-check"></i>
              Approve
            </button>
            <button class="btn btn-sm btn-reject" (click)="showRejectionModal(delivery)" title="Reject Partner">
              <i class="fas fa-times"></i>
              Reject
            </button>
          </div>

          <div class="action-group" *ngIf="delivery.verificationStatus !== 'pending'">
            <button class="btn btn-sm btn-secondary" (click)="toggleDeliveryStatus(delivery)"
              [title]="delivery.isActive ? 'Deactivate' : 'Activate'">
              <i [class]="delivery.isActive ? 'fas fa-pause' : 'fas fa-play'"></i>
              {{ delivery.isActive ? 'Deactivate' : 'Activate' }}
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Pagination -->
    <div class="pagination-section" *ngIf="totalPages > 1">
      <div class="pagination-info">
        <span>Showing {{ (currentPage - 1) * pageSize + 1 }} to {{ currentPage * pageSize > filteredDelivery.length ?
          filteredDelivery.length : currentPage * pageSize }} of {{ filteredDelivery.length }} delivery partners</span>
      </div>
      <nav class="pagination">
        <button class="page-btn" [disabled]="currentPage === 1" (click)="onPageChange(currentPage - 1)">
          <i class="fas fa-chevron-left"></i>
        </button>
        <button *ngFor="let page of generatePageNumbers()" class="page-btn" [class.active]="page === currentPage"
          (click)="onPageChange(page)">
          {{ page }}
        </button>
        <button class="page-btn" [disabled]="currentPage === totalPages" (click)="onPageChange(currentPage + 1)">
          <i class="fas fa-chevron-right"></i>
        </button>
      </nav>
    </div>
  </div>

  <!-- Empty State -->
  <div *ngIf="!isLoading && filteredDelivery.length === 0" class="empty-state">
    <div class="empty-content">
      <i class="fas fa-motorcycle empty-icon"></i>
      <h3>No Delivery Partners Found</h3>
      <p>There are no delivery partners matching your current filters.</p>
      <button class="btn btn-primary" (click)="onSearchChange()">
        <i class="fas fa-times"></i>
        Clear Filters
      </button>
    </div>
  </div>
</div>

<!-- Delivery Details Modal -->
<div class="modal" [class.show]="showDeliveryModal" [style.display]="showDeliveryModal ? 'block' : 'none'">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-motorcycle"></i>
          Delivery Partner Full Details
        </h5>
        <button type="button" class="btn-close" (click)="closeModal()"></button>
      </div>
      <div class="modal-body" *ngIf="currentDelivery">
        <div class="delivery-profile">
          <!-- Profile Header -->
          <div class="profile-header">
            <div class="delivery-avatar-large">
              <img [src]="currentDelivery.documents?.identityProof || 'assets/default-avatar.png'"
                alt="Delivery Partner" (error)="handleImageError($event)">
            </div>
            <div class="profile-info">
              <h3>{{ currentDelivery.firstName }} {{ currentDelivery.lastName }}</h3>
              <div class="profile-meta">
                <span class="delivery-id">ID: {{ currentDelivery._id }}</span>
                <span class="join-date">Joined: {{ formatDateTime(currentDelivery.createdAt) }}</span>
                <span class="last-login">Last Active: {{ currentDelivery.lastLogin ?
                  formatDateTime(currentDelivery.lastLogin) : 'Never' }}</span>
              </div>
              <div class="status-badges">
                <span class="status-badge" [ngClass]="getStatusBadgeClass(currentDelivery.verificationStatus)">
                  <i
                    [class]="'fas fa-' + (currentDelivery.verificationStatus === 'pending' ? 'clock' : currentDelivery.verificationStatus === 'verified' ? 'check' : 'times')"></i>
                  {{ currentDelivery.verificationStatus | titlecase }}
                </span>
                <span class="status-badge" [ngClass]="currentDelivery.isOnline ? 'online' : 'offline'">
                  <i class="fas fa-circle"></i>
                  {{ currentDelivery.isOnline ? 'Online' : 'Offline' }}
                </span>
                <span class="status-badge" [ngClass]="currentDelivery.isActive ? 'active' : 'inactive'">
                  <i class="fas fa-power-off"></i>
                  {{ currentDelivery.isActive ? 'Active' : 'Inactive' }}
                </span>
              </div>
            </div>
          </div>

          <!-- Main Details Sections -->
          <div class="details-sections">
            <!-- Personal Information -->
            <div class="details-section">
              <h6 class="section-title">
                <i class="fas fa-user"></i> Personal Information
              </h6>
              <div class="detail-grid">
                <div class="detail-item">
                  <span class="detail-label">Email:</span>
                  <span class="detail-value">{{ currentDelivery.email }}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Phone:</span>
                  <span class="detail-value">{{ currentDelivery.phone }}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Address:</span>
                  <span class="detail-value">
                    {{ currentDelivery.address?.street }}, {{ currentDelivery.address?.city }},
                    {{ currentDelivery.address?.state }} {{ currentDelivery.address?.zipCode }}
                  </span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Delivery Zones:</span>
                  <span class="detail-value">
                    <span class="zone-tag" *ngFor="let zone of currentDelivery.deliveryZones">{{ zone }}</span>
                  </span>
                </div>
              </div>
            </div>

            <!-- Vehicle Information -->
            <div class="details-section">
              <h6 class="section-title">
                <i class="fas fa-car"></i> Vehicle Information
              </h6>
              <div class="detail-grid">
                <div class="detail-item">
                  <span class="detail-label">Type:</span>
                  <span class="detail-value vehicle-type" [ngClass]="currentDelivery.vehicleInfo.type">
                    <i [class]="getVehicleIcon(currentDelivery.vehicleInfo.type || '')"></i>
                    {{ currentDelivery.vehicleInfo.type | titlecase }}
                  </span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Model:</span>
                  <span class="detail-value">{{ currentDelivery.vehicleInfo.model }}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Brand:</span>
                  <span class="detail-value">{{ currentDelivery.vehicleInfo.brand }}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">License Plate:</span>
                  <span class="detail-value">{{ currentDelivery.vehicleInfo.plateNumber }}</span>
                </div>
              </div>
            </div>

            <!-- Documents -->
            <div class="details-section">
              <h6 class="section-title">
                <i class="fas fa-file-contract"></i> Documents
              </h6>
              <div class="document-grid">
                <div class="document-card" (click)="openDocument(currentDelivery.documents?.licenseImage)">
                  <div class="document-preview">
                    <img [src]="currentDelivery.documents?.licenseImage || 'assets/default-document.png'"
                      alt="Driver License" (error)="handleImageError($event)">
                  </div>
                  <div class="document-info">
                    <h6>Driver License</h6>
                    <p>{{ currentDelivery.documents?.licenseNumber || 'Not provided' }}</p>
                  </div>
                </div>
                <div class="document-card" (click)="openDocument(currentDelivery.documents?.vehicleRegistration)">
                  <div class="document-preview">
                    <img [src]="currentDelivery.documents?.vehicleRegistration || 'assets/default-document.png'"
                      alt="Vehicle Registration" (error)="handleImageError($event)">
                  </div>
                  <div class="document-info">
                    <h6>Vehicle Registration</h6>
                  </div>
                </div>
                <div class="document-card" (click)="openDocument(currentDelivery.documents?.identityProof)">
                  <div class="document-preview">
                    <img [src]="currentDelivery.documents?.identityProof || 'assets/default-document.png'"
                      alt="ID Proof" (error)="handleImageError($event)">
                  </div>
                  <div class="document-info">
                    <h6>Identity Proof</h6>
                  </div>
                </div>
              </div>
            </div>

            <!-- Working Hours -->
            <div class="details-section" *ngIf="currentDelivery.workingHours">
              <h6 class="section-title">
                <i class="fas fa-clock"></i> Working Hours
              </h6>
              <div class="working-hours-grid">
                <div class="day-slot" *ngFor="let day of getWeekDays()"
                  [class.day-off]="!currentDelivery.workingHours![day].isWorking">
                  <span class="day-name">{{ day | titlecase }}</span>
                  <span class="day-hours" *ngIf="currentDelivery.workingHours![day].isWorking">
                    {{ currentDelivery.workingHours![day].start }} - {{ currentDelivery.workingHours![day].end }}
                  </span>
                  <span class="day-off" *ngIf="!currentDelivery.workingHours![day].isWorking">
                    Not working
                  </span>
                </div>
              </div>
            </div>

            <!-- Performance Metrics -->
            <div class="details-section">
              <h6 class="section-title">
                <i class="fas fa-chart-line"></i> Performance Metrics
              </h6>
              <div class="metrics-grid">
                <div class="metric-card">
                  <div class="metric-icon">
                    <i class="fas fa-star"></i>
                  </div>
                  <div class="metric-info">
                    <h6>Average Rating</h6>
                    <p class="metric-value">{{ currentDelivery.ratings?.averageRating || 0 }} <small>/5</small></p>
                    <p class="metric-detail">{{ currentDelivery.ratings?.totalReviews || 0 }} reviews</p>
                  </div>
                </div>
                <div class="metric-card">
                  <div class="metric-icon">
                    <i class="fas fa-money-bill-wave"></i>
                  </div>
                  <div class="metric-info">
                    <h6>Total Earnings</h6>
                    <p class="metric-value">${{ currentDelivery.earnings?.totalEarnings || 0 }}</p>
                    <p class="metric-detail">Lifetime</p>
                  </div>
                </div>
                <div class="metric-card">
                  <div class="metric-icon">
                    <i class="fas fa-calendar-day"></i>
                  </div>
                  <div class="metric-info">
                    <h6>Today's Earnings</h6>
                    <p class="metric-value">${{ currentDelivery.earnings?.todayEarnings || 0 }}</p>
                  </div>
                </div>
                <div class="metric-card">
                  <div class="metric-icon">
                    <i class="fas fa-truck"></i>
                  </div>
                  <div class="metric-info">
                    <h6>Completed Deliveries</h6>
                    <p class="metric-value">{{ currentDelivery.deliveryHistory?.length || 0 }}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeModal()">Close</button>
        <button *ngIf="currentDelivery && currentDelivery.verificationStatus === 'pending'" type="button"
          class="btn btn-success" (click)="approveDelivery(currentDelivery, 'verified')">
          <i class="fas fa-check"></i>
          Approve
        </button>
        <button *ngIf="currentDelivery && currentDelivery.verificationStatus === 'pending'" type="button"
          class="btn btn-danger" (click)="showRejectionModal(currentDelivery)">
          <i class="fas fa-times"></i>
          Reject
        </button>
        <button *ngIf="currentDelivery" type="button" class="btn btn-primary"
          (click)="toggleDeliveryStatus(currentDelivery)">
          <i [class]="currentDelivery.isActive ? 'fas fa-pause' : 'fas fa-play'"></i>
          {{ currentDelivery.isActive ? 'Deactivate' : 'Activate' }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Rejection Modal -->
<div class="modal" [class.show]="showRejectionReasonModal"
  [style.display]="showRejectionReasonModal ? 'block' : 'none'">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-exclamation-triangle"></i>
          Rejection Reason
        </h5>
        <button type="button" class="btn-close" (click)="closeRejectionModal()"></button>
      </div>
      <form [formGroup]="rejectionForm" (ngSubmit)="submitRejection()">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Reason for Rejection</label>
            <select class="form-select" formControlName="reason" required>
              <option value="">Select a reason</option>
              <option value="documents">Incomplete Documents</option>
              <option value="quality">Poor Document Quality</option>
              <option value="information">Incorrect Information</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Additional Notes</label>
            <textarea class="form-control" formControlName="notes" rows="3"
              placeholder="Provide specific details for the rejection..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeRejectionModal()">Cancel</button>
          <button type="submit" class="btn btn-danger" [disabled]="!rejectionForm.valid">
            <i class="fas fa-times"></i>
            Confirm Rejection
          </button>
        </div>
      </form>
    </div>
  </div>
</div>