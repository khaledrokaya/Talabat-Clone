<div class="order-details-container">
  <div class="container">
    <!-- Header Section -->
    <header class="header-section">
      <button class="back-btn"
        [routerLink]="!isRestaurantOwner ? '/orders' : '/restaurant-dashboard/orders-management'">
        <i class="fas fa-arrow-left"></i> Back to Orders
      </button>
      <h1>Order Details</h1>
    </header>

    <!-- Loading State -->
    <section class="loading" *ngIf="loading" aria-live="polite" aria-busy="true">
      <div class="loading-spinner" aria-hidden="true"></div>
      <p>Loading order details...</p>
    </section>

    <!-- Success Message -->
    <div class="success-message" *ngIf="successMessage" role="alert">
      <i class="fas fa-check-circle success-icon"></i>
      <span>{{ successMessage }}</span>
    </div>

    <!-- Error State -->
    <div class="error-message" *ngIf="errorMessage" role="alert">
      <i class="fas fa-exclamation-circle error-icon"></i>
      <span>{{ errorMessage }}</span>
    </div>

    <!-- Main Order Content -->
    <main class="order-details-content" *ngIf="!loading && !errorMessage && order">
      <!-- Order Header Card -->
      <article class="order-card order-header-card">
        <div class="order-info">
          <div class="order-number">
            <h2>Order #{{ order.orderNumber || order._id?.slice(-6) }}</h2>
            <span class="status-badge status-{{order.status}}">
              {{ getStatusText(order.status) }}
            </span>
          </div>
          <div class="order-meta">
            <p><strong>Placed on:</strong> {{ formatDate(order.createdAt) }}</p>
            <p *ngIf="order.preparationTime">
              <strong>Preparation Time:</strong> {{ order.preparationTime }} minutes
            </p>
          </div>
        </div>
      </article>

      <!-- Customer Info (if restaurant owner) -->
      <article class="order-card customer-card" *ngIf="order.customerInfo && isRestaurantOwner">
        <h3>Customer Information</h3>
        <div class="details-container">
          <div class="info-content">
            <h4>{{ order.customerInfo.name }}</h4>
            <p><strong>Phone:</strong> {{ order.customerInfo.phone }}</p>
            <p><strong>Email:</strong> {{ order.customerInfo.email }}</p>
          </div>
        </div>
      </article>

      <!-- Restaurant Info -->
      <article class="order-card restaurant-card" *ngIf="order.restaurantId">
        <h3>Restaurant Information</h3>
        <div class="details-container">
          <div class="info-content">
            <h4>{{ order.restaurantId.name }}</h4>
            <p><strong>Address:</strong> {{ order.restaurantId.address }}</p>
            <p *ngIf="order.restaurantId.phone">
              <strong>Phone:</strong> {{ order.restaurantId.phone }}
            </p>
          </div>
        </div>
      </article>

      <!-- Order Items -->
      <article class="order-card items-card">
        <h3>Order Items ({{ order.items.length }})</h3>
        <div class="order-items">
          <section class="order-item" *ngFor="let item of order.items">
            <div class="item-info">
              <h4 class="item-name">{{ item.name }}</h4>
              <div class="item-details">
                <span class="item-quantity">Quantity: {{ item.quantity }}</span>
                <span class="item-price">{{ formatCurrency(item.price) }} each</span>
              </div>
              <div class="item-instructions" *ngIf="item.specialInstructions">
                <small><strong>Special Instructions:</strong> {{ item.specialInstructions }}</small>
              </div>
            </div>
            <div class="item-total">
              {{ formatCurrency(item.price * item.quantity) }}
            </div>
          </section>
        </div>
      </article>

      <!-- Delivery Address -->
      <article class="order-card address-card" *ngIf="order.deliveryAddress">
        <h3>Delivery Address</h3>
        <address class="address-details">
          <p>{{ order.deliveryAddress.street }}</p>
          <p>{{ order.deliveryAddress.city }}, {{ order.deliveryAddress.state }} {{ order.deliveryAddress.zipCode }}</p>
          <p *ngIf="order.deliveryAddress.additionalInfo">
            <strong>Additional Info:</strong> {{ order.deliveryAddress.additionalInfo }}
          </p>
          <div class="coordinates" *ngIf="order.deliveryAddress.coordinates">
            <small>Coordinates: {{ order.deliveryAddress.coordinates.lat }}, {{ order.deliveryAddress.coordinates.lng
              }}</small>
          </div>
        </address>
      </article>

      <!-- Order Instructions -->
      <article class="order-card instructions-card" *ngIf="order.specialInstructions">
        <h3>Special Instructions</h3>
        <div class="instructions-content">
          <p>{{ order.specialInstructions }}</p>
        </div>
      </article>

      <!-- Payment Information -->
      <article class="order-card payment-card">
        <h3>Payment Information</h3>
        <div class="payment-details">
          <div class="payment-method">
            <p><strong>Payment Method:</strong> {{ order.paymentMethod | titlecase }}</p>
            <p><strong>Payment Status:</strong>
              <span class="status-badge payment-{{order.paymentStatus}}">
                {{ order.paymentStatus | titlecase }}
              </span>
            </p>
          </div>
        </div>
      </article>

      <!-- Order Timeline -->
      <article class="order-card timeline-card" *ngIf="order.statusHistory?.length > 0">
        <h3>Order Timeline</h3>
        <div class="timeline">
          <div class="timeline-item" *ngFor="let event of order.statusHistory"
            [class.active]="event.status === order.status">
            <div class="timeline-dot" aria-hidden="true"></div>
            <div class="timeline-content">
              <div class="timeline-status">{{ getStatusText(event.status) }}</div>
              <div class="timeline-time">{{ formatDate(event.timestamp) }}</div>
              <div class="timeline-description" *ngIf="event.description">{{ event.description }}</div>
            </div>
          </div>
        </div>
      </article>

      <!-- Pricing Summary -->
      <article class="order-card pricing-card">
        <h3>Order Summary</h3>
        <div class="pricing-details">
          <div class="price-row">
            <span>Subtotal:</span>
            <span>{{ formatCurrency(order.subtotal) }}</span>
          </div>
          <div class="price-row" *ngIf="order.deliveryFee">
            <span>Delivery Fee:</span>
            <span>{{ formatCurrency(order.deliveryFee) }}</span>
          </div>
          <div class="price-row" *ngIf="order.tax">
            <span>Tax:</span>
            <span>{{ formatCurrency(order.tax) }}</span>
          </div>
          <div class="price-row" *ngIf="order.discount && order.discount > 0">
            <span>Discount:</span>
            <span class="discount">-{{ formatCurrency(order.discount) }}</span>
          </div>
          <div class="price-row total">
            <span>Total:</span>
            <span>{{ formatCurrency(order.totalAmount) }}</span>
          </div>
        </div>
      </article>

      <!-- Action Buttons -->
      <article class="order-card actions-card">
        <div class="action-buttons">
          <!-- Customer Actions -->
          <ng-container *ngIf="!isRestaurantOwner">
            <button class="btn btn-primary" *ngIf="order.status === 'out_for_delivery' || order.status === 'preparing'"
              (click)="trackOrder()">
              <i class="fas fa-map-marker-alt"></i> Track Order
            </button>

            <button class="btn btn-danger" *ngIf="order.status === 'pending' || order.status === 'confirmed'"
              (click)="cancelOrder()">
              <i class="fas fa-times-circle"></i> Cancel Order
            </button>

            <button class="btn btn-success" *ngIf="order.status === 'delivered'" (click)="rateOrder()">
              <i class="fas fa-star"></i> Rate Order
            </button>
          </ng-container>

          <!-- Restaurant Owner Actions -->
          <ng-container *ngIf="isRestaurantOwner">
            <button class="btn btn-success" *ngIf="order.status === 'pending'" (click)="confirmOrder()">
              <i class="fas fa-check"></i> Confirm Order
            </button>

            <button class="btn btn-danger" *ngIf="order.status === 'pending'" (click)="rejectOrder()">
              <i class="fas fa-ban"></i> Reject Order
            </button>

            <button class="btn btn-primary" *ngIf="order.status === 'confirmed'" (click)="startPreparing()">
              <i class="fas fa-utensils"></i> Start Preparing
            </button>

            <button class="btn btn-warning" *ngIf="order.status === 'preparing'" (click)="markReady()">
              <i class="fas fa-check-double"></i> Mark Ready
            </button>

            <button class="btn btn-info" *ngIf="order.status === 'ready'" (click)="markOutForDelivery()">
              <i class="fas fa-truck"></i> Out for Delivery
            </button>

            <button class="btn btn-success" *ngIf="order.status === 'out_for_delivery'" (click)="markDelivered()">
              <i class="fas fa-clipboard-check"></i> Mark Delivered
            </button>
          </ng-container>
        </div>
      </article>
    </main>

    <!-- No Order Found -->
    <article class="order-card no-order" *ngIf="!loading && !errorMessage && !order">
      <div class="no-order-icon">
        <i class="fas fa-box-open"></i>
      </div>
      <h3>Order Not Found</h3>
      <p>The order you're looking for could not be found. It may have been cancelled or the ID might be incorrect.</p>
      <button class="btn btn-primary" routerLink="/orders">
        <i class="fas fa-arrow-left"></i> Back to Orders
      </button>
    </article>
  </div>
</div>